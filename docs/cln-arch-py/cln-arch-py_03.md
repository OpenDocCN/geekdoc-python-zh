# 第一章 - 清洁系统的一天

> 原文：[`www.thedigitalcatbooks.com/pycabook-chapter-01/`](https://www.thedigitalcatbooks.com/pycabook-chapter-01/)
> 
> 必须是我的幸运日。
> 
> 终结者 2，1991

在本章中，我将向读者介绍一个（非常简单）采用清晰架构设计的系统。本章的目的是使读者熟悉主要概念，如关注点分离和反转控制，这些在系统设计中至关重要。在描述数据在系统中的流动时，我将故意省略细节，以便我们能够关注全局观念，不必过于担心实现细节。这个例子将在接下来的章节中详细探讨，因此将有时间讨论具体的选择。现在，试着把握整体图景。

## 数据流

在本书的其余部分，我们将共同设计一个简单网络应用程序的一部分，该应用程序提供房间租赁系统。因此，让我们假设我们的“Rent-o-Matic”应用程序^([1])运行在[`www.rentomatic.com`](https://www.rentomatic.com)，并且用户想要查看可用的房间。他们打开浏览器并输入地址，然后点击菜单和按钮，到达显示我们公司租赁的所有房间列表的页面。

假设这个 URL 是`/rooms?status=available`。当用户的浏览器访问这个 URL 时，一个 HTTP 请求到达我们的系统，系统中有一个等待 HTTP 连接的组件。让我们称这个组件为“网络框架"^([2]).

网络框架的目的是理解 HTTP 请求并检索我们需要提供响应的数据。在这个简单案例中，请求有两个重要部分，即端点本身（`/rooms`）和一个单一的查询字符串参数，`status=available`。端点就像是我们系统的命令，因此当用户访问其中一个端点时，他们向系统发出请求特定服务的信号，在这种情况下是列出所有可出租的房间。

![The web framework serving HTTP](img/a310516e1746da7b71d809116b6ca785.png)The web framework serving HTTP

网络框架操作的范围是 HTTP 协议的领域，因此当网络框架解码请求后，它应将相关信息传递给另一个将处理它的组件。这个其他组件被称为*用例*，它是整个清晰系统的关键和最重要的组件，因为它实现了*业务逻辑*。

![The business logic](img/afc423201f73500320f3bca14eafc350.png)The business logic

业务逻辑是系统设计中的一个重要概念。你创建系统是因为你有一些你认为可能对世界有用的知识，或者至少是可销售的。最终，这种知识是一种处理数据的方式，是一种提取或展示数据的方式，可能是其他人没有的。搜索引擎可以找到与查询中的术语相关的所有网页，社交网络显示你关注的用户的帖子，并按特定的算法排序，旅行社为你找到两个地点之间的最佳旅行选择，等等。所有这些都是业务逻辑的好例子。

*业务逻辑

业务逻辑是你想要实现的具体算法或过程，是你将数据转换为提供服务的样子。它是系统中最重要的一部分。

用例实现了整个业务逻辑的一个非常具体的部分。在这种情况下，我们有一个用例来搜索具有给定参数`status`值的房间。这意味着用例必须提取我们公司管理的所有房间，并过滤它们以仅显示可用的房间。

*为什么 Web 框架不能这样做？嗯，良好的系统架构的主要目的是*分离关注点*，也就是说，保持不同的责任和领域分离。Web 框架在那里处理 HTTP 协议，由关注该系统特定部分的程序员维护，将业务逻辑添加到其中将两个非常不同的领域混合在一起。

**关注点分离

系统的不同部分应该管理不同的过程部分。当系统的两个独立部分在相同的数据或过程的同一部分上工作时，它们是*耦合的*。虽然耦合是不可避免的，但两个组件之间的耦合度越高，在不影响另一个组件的情况下更改一个组件就越困难。

正如我们将看到的，分离层可以让我们以更少的努力维护系统，使系统的单个部分更容易测试和替换。

在我们讨论的例子中，用例需要检索所有处于可用状态的房间，从数据源中提取它们。这是业务逻辑，在这种情况下它非常直接，因为它可能只涉及对属性值的简单过滤。然而，情况可能并非如此。更高级的业务逻辑的例子可能基于推荐系统进行排序，这可能需要用例与比数据源更多的组件进行连接。

因此，用例想要处理的信息存储在某个地方。让我们称这个组件为**存储系统**。你们中的许多人可能已经在脑海中想象了一个数据库，可能是一个关系型数据库，但这只是可能的数据源之一。存储系统所代表的抽象是：用例可以访问并能提供数据的任何东西都是一个源。它可能是一个文件、一个数据库（无论是关系型还是非关系型）、一个网络端点或一个远程传感器。

***抽象

在设计系统时，以抽象或构建块的方式思考至关重要。组件在系统中有其作用，而不管该组件的具体实现方式如何。抽象级别越高，组件的细节就越少。显然，高级抽象不考虑实际问题，这就是为什么抽象设计必须通过特定的解决方案或技术来实现。***

为了简化起见，让我们在这个例子中使用一个关系型数据库，比如 Postgres，因为它可能对大多数读者来说都很熟悉，但请记住更通用的情况。

![](img/07c9999c184018213f3bfc4b4c902b70.png)存储

如何将用例与存储系统连接起来？显然，如果我们将针对特定系统的调用（例如使用 SQL）硬编码到用例中，这两个组件将会**紧密耦合**，这是我们试图在系统设计中避免的事情。耦合的组件不是独立的，它们紧密相连，一个组件中的变化会强制另一个组件发生变化（反之亦然）。这也意味着测试组件会更加困难，因为一个组件不能没有另一个组件而存在，而当第二个组件是一个复杂的系统，如数据库时，这可能会严重减缓开发速度。

例如，让我们假设有一个用例直接调用特定的 Python 库来访问 PostgreSQL，比如 [psycopg](https://www.psycopg.org/)。这将使用例与该特定源耦合，数据库的改变将导致其代码的改变。这远非理想，因为用例包含的业务逻辑在从一种数据库系统迁移到另一种数据库系统时并未改变。系统中不包含业务逻辑的部分应被视为实现细节。

****实现细节

当一个解决方案或技术不是整体设计中的核心时，它被称为**细节**。这个词并不指代主题固有的复杂性，其复杂性可能大于更核心的部分。****

关系数据库比 HTTP 端点丰富和复杂数百倍，而这反过来又比按顺序排列对象列表复杂，但应用程序的核心是使用场景，而不是我们存储数据的方式或提供访问数据的方式。通常，实现细节主要与性能或可用性相关，而核心部分实现的是纯业务逻辑。

如何避免强耦合？一个简单的解决方案叫做*控制反转*，我将在这里简要描述它，并在本书的后续部分展示一个适当的实现，当我们实现这个例子时。

控制反转发生在两个阶段。首先，被调用对象（在这个例子中是数据库）被一个标准接口包装。这是一组由目标实现的每个实现共享的功能，每个接口将功能转换为对包装实现的具体语言的调用。

控制反转

一种用于避免系统组件之间强耦合的技术，它涉及将它们包装起来，以便它们暴露出一定的接口。一个期望该接口的组件可以连接到它们，而无需了解特定实现的细节，因此它被强耦合到接口而不是特定实现。

一个现实世界的例子是电源插座：电器设计成可以连接到任何符合规格（尺寸、极数等）的电源插座，而不是特定的电源插座。当你在英国购买电视时，你期望它带有英国插座（BS 1363）。如果没有，你需要一个*适配器*，这样你就可以将电子设备插入外国国家的插座。在这种情况下，我们需要将使用场景（电视）连接到一个数据库（电源系统）上，而这个数据库并没有设计成匹配一个通用接口。

在我们讨论的例子中，使用场景需要提取具有给定状态的所有房间，因此数据库包装器需要提供一个单一的入口点，我们可以称之为 `list_rooms_with_status`。

![存储接口](img/85cec2f977b76c2397802b1486f0b7ba.png)存储接口

在控制反转的第二阶段，调用者（使用场景）被修改以避免硬编码对特定实现的调用，因为这又会将两者耦合在一起。使用场景接受一个作为其构造函数参数的传入对象，并在创建时接收适配器的具体实例。实现这一特定技术的方法在很大程度上取决于我们使用的编程语言。Python 没有显式的接口语法，所以我们假设我们传递的对象实现了所需的方法。

![存储接口上的控制反转](img/aa24cf11fcf4a3e27515f07ca4bbc306.png)存储接口上的控制反转

现在用例已经连接到适配器并知道了接口，它可以调用`list_rooms_with_status`入口点，传递状态`available`。适配器知道存储系统的细节，因此它将方法调用和参数转换为特定的调用（或一系列调用），以提取所需的数据，然后将它们转换为用例期望的格式。例如，它可能返回一个表示房间的 Python 字典列表。

![业务逻辑从存储中提取数据](img/a0de932ea207de9d0894271b2353b1c9.png)业务逻辑从存储中提取数据

在这个阶段，用例必须应用剩余的业务逻辑（如果需要的话），并将结果返回给 Web 框架。

![业务逻辑将处理后的数据返回给 Web 框架](img/412e495f5aa209edd764e1fa65824bcc.png)业务逻辑将处理后的数据返回给 Web 框架

Web 框架将用例接收到的数据转换为 HTTP 响应。在这种情况下，因为我们正在考虑一个用户应该明确访问的端点，所以 Web 框架将在响应体中返回一个 HTML 页面，但如果这是一个内部端点，例如由前端中的某些异步 JavaScript 代码调用，响应体可能只是一个 JSON 结构。

![Web 框架在 HTTP 响应中返回数据](img/e4b6ce92027a26aa198e39c8d4afa4b5.png)Web 框架在 HTTP 响应中返回数据

## 分层架构的优势

如你所见，这个过程的各个阶段是明显分开的，它们之间有大量的数据转换。使用常见的数据格式是我们实现计算机系统组件之间独立性的方法之一。

为了更好地理解松耦合对程序员意味着什么，让我们考虑最后一张图。在前面的段落中，我给出了一个使用 Web 框架作为用户界面和关系型数据库作为数据源的系统的例子，但如果前端部分是一个命令行界面会发生什么变化？如果，而不是关系型数据库，有一个其他类型的数据源，例如一组文本文件，会发生什么变化？

![Web 框架被 CLI 取代](img/179d70402b2999599ed5160872cb40ed.png)Web 框架被 CLI 取代******![数据库被更简单的基于文件的存储取代](img/063c5d5885cb494eb48ab604e8507c5d.png)数据库被更简单的基于文件的存储取代

正如你所见，这两个更改都需要替换一些组件。毕竟，我们需要不同的代码来管理命令行而不是网页。但系统的外部形状并没有改变，数据流动的方式也没有改变。我们创建了一个系统，其中用户界面（Web 框架、命令行界面）和数据源（关系数据库、文本文件）是实现的细节，而不是其核心部分。

然而，分层架构的主要直接优势是可测试性。当你清楚地分离组件时，你可以清楚地确定每个组件需要接收和产生哪些数据，因此你可以理想地断开单个组件并对其进行单独测试。让我们暂时忽略其他架构，考虑我们添加的 Web 框架组件。如图所示

![单独测试网络层](img/d224037cf8f8a3df62c3dd6ed643fa3e.png)单独测试网络层******![网络层测试的详细设置，宽度=80%](img/0bc5e22566f89d5f79ef5be8103fe6aa.png)网络层测试的详细设置

我们知道 Web 框架接收一个带有特定目标和特定查询字符串的 HTTP 请求（1），并且它必须调用（2）用例上的一个方法，传递特定的参数。当用例返回数据（3）时，Web 框架必须将其转换为 HTTP 响应（4）。由于这是一个测试，我们可以有一个模拟用例，即一个仅模仿用例行为而不真正实现业务逻辑的对象。然后我们将测试 Web 框架是否以正确的参数调用方法（2），以及 HTTP 响应（4）是否包含正确格式的数据，所有这一切都将不涉及系统的任何其他部分。

 * 

因此，现在我们已经对系统有了 10,000 英尺的高度概述，让我们更深入地了解其组件及其背后的概念。在下一章中，我将详细说明被称为“清洁架构”的设计原则如何帮助有效地实现和利用诸如关注点分离、抽象、实现和控制反转等概念。

***1

我受到了《时空怪客》中的 Sludge-O-Matic™的启发*** ***2

在到达实际的 Web 框架之前，HTTP 请求必须通过许多其他层，例如 Web 服务器，但由于这些层的目的是主要提高性能，我将在本书的结尾再考虑它们。*** ***3

在这里，“语言”一词是指其更广泛的意义。它可能是一种编程语言，也可能是 API、数据格式或协议。***
